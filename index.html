<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vestas Turbine Interactive</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Inter', sans-serif; background-color: #1a202c; color: #e2e8f0; }
        #webgl-output { display: block; width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 1; }
        #fade-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #fff; opacity: 0; pointer-events: none; z-index: 9999; transition: opacity 0.5s; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: #fff; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10000; }
        .welcome-text { font-family: 'Inter', sans-serif; font-weight: 400; font-size: 1.2em; letter-spacing: 0.2px; color: #222; margin-top: 1em; opacity: 0.85; text-align: center; }
        .hotspot-popup { position: absolute; background: #fff; color: #222; border-radius: 0 !important; box-shadow: 0 8px 32px rgba(0,0,0,0.2); padding: 1.5rem 1.5rem 1rem 1.5rem; min-width: 260px; z-index: 20; display: none; }
        .hotspot-popup h3 { margin-top: 0; font-size: 1.2em; font-weight: bold; }
        .hotspot-popup .close-btn { position: absolute; top: 8px; right: 12px; background: none; border: none; font-size: 1.2rem; cursor: pointer; }
        .popup-btn-row { display: flex; flex-direction: row; justify-content: flex-end; margin-top: 1.2em; }
        #explore-btn { background: #014282 !important; color: #fff !important; border-radius: 0 !important; border: none; box-shadow: none; padding: 8px 18px; font-size: 1rem; font-family: inherit; }
        #explore-btn:hover { background: #2363a4 !important; }
        .back-btn { display:none; position:fixed; top:32px; left:32px; width:48px; height:48px; padding:0; background:none; border:none; z-index:10001; cursor:pointer; }
        .back-btn svg { display:block; width:100%; height:100%; }
        .back-btn svg rect { fill: #39b5eb !important; }
        .hotspot-dom-marker {
            position: absolute;
            border-radius: 50%;
            box-shadow: 0 2px 8px 0 rgba(57,181,235,0.22);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: #39b5eb;
            transition: background 0.3s cubic-bezier(.4,2.3,.3,1), width 0.18s, height 0.18s;
            z-index: 15;
            user-select: none;
            outline: none;
        }
        .hotspot-dom-marker svg {
            display: block;
            width: 18px;
            height: 18px;
            pointer-events: none;
        }
        .hotspot-dom-marker:hover, .hotspot-dom-marker.active {
            background: #444444;
        }
        .hotspot-tooltip {
            position: absolute;
            left: 110%;
            top: 50%;
            transform: translateY(-50%) translateX(8px);
            background: #f0f0f0;
            color: #333;
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            font-weight: 500;
            border-radius: 0px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.10);
            padding: 4px 10px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.22s, transform 0.22s;
            z-index: 99;
            white-space: nowrap;
            visibility: hidden;
            border: 1px solid #e2e8f0;
        }
        .hotspot-dom-marker:hover .hotspot-tooltip, .hotspot-dom-marker.active .hotspot-tooltip {
            opacity: 1;
            visibility: visible;
            transform: translateY(-50%) translateX(0px);
        }
        @media (max-width: 600px) {
            .hotspot-popup { min-width: 160px; padding: 1em 0.8em 0.6em 0.8em; }
            .welcome-text { font-size: 1em; }
            .popup-btn-row { margin-top: 0.7em; }
        }
    </style>
</head>
<body>
    <div id="fade-overlay"></div>
    <div id="loading-overlay">
        <img src="loadernew.svg" alt="Loading..." width="80" height="80" />
        <p class="welcome-text">Welcome to Turbine Tour</p>
    </div>
    <div id="webgl-output"></div>
    <div id="hotspot-popup" class="hotspot-popup">
        <button class="close-btn" id="popup-close-btn" aria-label="Close">&times;</button>
        <h3 id="popup-title"></h3>
        <p id="popup-desc"></p>
        <div class="popup-btn-row">
            <button id="explore-btn">Explore</button>
        </div>
    </div>
    <button id="back-btn" class="back-btn" title="Back to main">
        <svg viewBox="0 0 48 48">
            <rect x="0" y="0" width="48" height="48"/>
            <polyline points="30,16 20,24 30,32" fill="none" stroke="#fff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </button>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script>
    // --- Material references
    let towerSpecialMats = [], towerSpecialOriginals = [];
    let carSpecialMats = [], carSpecialOriginals = [];
    let envTransparentMats = [], envOriginals = [];
    let bladesTransparentMats = [], bladesOriginals = [];
    let towerMaterialRef = null;
    let bladesModel = null, bladesPivot = null;

    let scene, camera, renderer;
    let controls = {};
    let activeView = "main";
    let allHotspotDomMarkers = [];
    const loadingOverlay = document.getElementById('loading-overlay');
    const container = document.getElementById('webgl-output');
    const fadeOverlay = document.getElementById('fade-overlay');
    const popup = document.getElementById('hotspot-popup');
    const popupTitle = document.getElementById('popup-title');
    const popupDesc = document.getElementById('popup-desc');
    const exploreBtn = document.getElementById('explore-btn');
    const popupCloseBtn = document.getElementById('popup-close-btn');
    const backBtn = document.getElementById('back-btn');
    const DEFAULT_SENSOR_SIZE = 35; // mm

    // --- Hotspot data ---
    const hotspotData = {
        main: [
            { name: "Turbine", position: {x: 0, y: 187, z: -10}, title: "Turbine", desc: "Go in-depth inside the Turbine.", view: "turbain" },
            { name: "Tower", position: {x: 0, y: 10, z: 0}, title: "Tower", desc: "Go in-depth inside the Tower.", view: "tower" },
            { name: "Car", position: {x: 25, y: 3, z: 1}, title: "Car", desc: "Go to Service Car.", view: "car" }
        ],
        turbain: [
            { name: "Drivetrain", position: {x: 0, y: 188, z: -5.3}, title: "Drivetrain", desc: "Drivetrain details" },
            { name: "Yaw", position: {x: 0, y: 183, z: -4.5}, title: "Yaw", desc: "Yaw system details" },
            { name: "Hydraulics", position: {x: -3, y: 187, z: -12}, title: "Hydraulics", desc: "Hydraulics details" },
            { name: "Power Generator", position: {x: 3, y: 187, z: -15}, title: "Power Generator", desc: "Power Generator details" },
            { name: "Controls & Safety", position: {x: -2, y: 187.5, z: -17}, title: "Controls & Safety", desc: "Controls & Safety details" },
            { name: "Hub", position: {x: 0, y: 187, z: 5.5}, title: "Hub", desc: "Turbine System details" },
            { name: "Power Supply", position: {x: 0, y: 187, z: -20.5}, title: "Power Supply", desc: "Power Supply details" }
        ],
        tower: [
            { name: "Safety", position: {x: -1.8, y: 9, z: -7.5}, title: "Safety", desc: "Safety details" },
            { name: "Turbine Operation", position: {x: +2, y: 8, z: -4.5}, title: "Turbine Operation", desc: "Turbine Operation details" }
        ],
        car: [
            { name: "Scheduled Service", position: {x: 22.5, y: 1, z: 1.8}, title: "Scheduled Service", desc: "Scheduled Service info" },
            { name: "Documentation", position: {x: 21, y: 2.3, z: 6}, title: "Documentation", desc: "Documentation info" },
            { name: "Trouble Shooting Tools", position: {x: 29, y: -1, z: 3.5}, title: "Trouble Shooting Tools", desc: "Trouble Shooting Tools info" }
        ]
    };
    function getHotspotVector(hotspot) {
        return new THREE.Vector3(hotspot.position.x, hotspot.position.y, hotspot.position.z);
    }

    // --- Camera setup for each view ---
    const cameras = {};
    cameras.main = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 2000);
    cameras.main.position.set(300, 90, 240);
    cameras.main.filmGauge = DEFAULT_SENSOR_SIZE;
    cameras.turbain = new THREE.PerspectiveCamera(20, window.innerWidth / window.innerHeight, 0.1, 2000);
    cameras.turbain.position.set(0, 300, 0);
    cameras.turbain.filmGauge = DEFAULT_SENSOR_SIZE;
    cameras.tower = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 2000);
    cameras.tower.position.set(20, 8, -5);
    cameras.tower.filmGauge = DEFAULT_SENSOR_SIZE;
    cameras.car = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 2000);
    cameras.car.position.set(
        hotspotData.car[0].position.x + 4,
        hotspotData.car[0].position.y + 8,
        hotspotData.car[0].position.z + 15
    );
    cameras.car.filmGauge = DEFAULT_SENSOR_SIZE;

    // --- Controls for each view ---
    controls.main = new THREE.OrbitControls(cameras.main, container);
    controls.main.target.copy(getHotspotVector(hotspotData.main[0]));
    controls.main.enableDamping = true;
    controls.main.dampingFactor = 0.05;
    controls.main.enablePan = false;
    controls.main.enableZoom = false;
    controls.main.minPolarAngle = 0;
    controls.main.maxPolarAngle = Math.PI / 2;
    controls.turbain = new THREE.OrbitControls(cameras.turbain, container);
    controls.turbain.target.copy(getHotspotVector(hotspotData.turbain[0]));
    controls.turbain.enableDamping = true;
    controls.turbain.dampingFactor = 0.05;
    controls.turbain.enablePan = false;
    controls.turbain.enableZoom = false;
    controls.tower = new THREE.OrbitControls(cameras.tower, container);
    controls.tower.target.copy(getHotspotVector(hotspotData.tower[0]));
    controls.tower.enableDamping = true;
    controls.tower.dampingFactor = 0.05;
    controls.tower.enablePan = false;
    controls.tower.enableZoom = false;
    controls.tower.minPolarAngle = 0;
    controls.tower.maxPolarAngle = Math.PI / 2;
    controls.car = new THREE.OrbitControls(cameras.car, container);
    controls.car.target.copy(getHotspotVector(hotspotData.car[0]));
    controls.car.enableDamping = true;
    controls.car.dampingFactor = 0.05;
    controls.car.enablePan = false;
    controls.car.enableZoom = false;
    controls.car.minAzimuthAngle = Math.PI / 4;
    controls.car.maxAzimuthAngle = (5 * Math.PI) / 4;
    controls.car.minPolarAngle = 0;
    controls.car.maxPolarAngle = Math.PI / 2;

    // --- Material handling functions ---
    const carSpecialMatNames = ["Mat_White","VestasLogoTransparent","Mat_Grey_03"];
    const turbainEnvMatNames = [
        "Nacelle_outershell","spoiler_outer","Transparent_flip","Nacelle","Skeleton","Red Emmition",
        "BaseFrame","New_skabe_etc","HubFrame"
    ];
    const turbainBladesMatNames = [
        "Hub_Blade1", "Transparent_flip", "HubFrame"
    ];
    function setCarSpecialOpacity(alpha) {
        carSpecialMats.forEach(mat => {
            mat.transparent = true;
            mat.opacity = alpha;
            mat.needsUpdate = true;
        });
    }
    function restoreCarSpecialOpacity() {
        carSpecialOriginals.forEach(orig => {
            orig.mat.opacity = orig.opacity;
            orig.mat.transparent = orig.transparent;
            orig.mat.needsUpdate = true;
        });
    }
    function setTowerSpecialOpacity(alpha) {
        towerSpecialMats.forEach(mat => { mat.transparent = true; mat.opacity = alpha; mat.needsUpdate = true; });
    }
    function restoreTowerSpecialOpacity() {
        towerSpecialOriginals.forEach(orig => {
            orig.mat.opacity = orig.opacity;
            orig.mat.transparent = orig.transparent;
            orig.mat.needsUpdate = true;
        });
    }
    function setAllMaterialsOpacityToLow() {
        envTransparentMats.forEach(mat => { mat.transparent = true; mat.opacity = 0.2; mat.needsUpdate = true; });
        bladesTransparentMats.forEach(mat => { mat.transparent = true; mat.opacity = 0.2; mat.needsUpdate = true; });
        if (bladesModel) bladesModel.visible = true;
    }
    function restoreEnvMaterials() {
        envOriginals.forEach(orig => {
            orig.mat.opacity = orig.opacity;
            orig.mat.transparent = orig.transparent;
            orig.mat.needsUpdate = true;
        });
    }
    function restoreBladesMaterials() {
        bladesOriginals.forEach(orig => {
            orig.mat.opacity = orig.opacity;
            orig.mat.transparent = orig.transparent;
            orig.mat.needsUpdate = true;
        });
    }
    function setBladesVisibility(isVisible) {
        if (bladesModel) bladesModel.visible = isVisible;
    }

    // --- INIT ---
    function init() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a202c);
        camera = cameras.main;
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        container.appendChild(renderer.domElement);
        scene.add(new THREE.AmbientLight(0xffffff, 0.5));
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(5, 10, 7);
        scene.add(dirLight);

        // --- Load windmillenv.glb and collect materials for fading
        const loader = new THREE.GLTFLoader();
        loader.load('windmillenv.glb', function (gltf) {
            const model = gltf.scene;
            model.scale.set(2, 2, 2);
            scene.add(model);

            // --- Original turbine fade materials ---
            const envMatNames = [
                "Nacelle_outershell","spoiler_outer","Transparent_flip","Nacelle","Skeleton","Red Emmition"
            ];
            const envMeshNames = [
                "MatChangeGroup11_Spoiler","MatChangeGroup5_Skeleton"
            ];
            envTransparentMats = []; envOriginals = [];
            towerSpecialMats = []; towerSpecialOriginals = [];
            carSpecialMats = []; carSpecialOriginals = [];
            // Tower special
            const towerSpecialMeshes = [
                "MatChangeGroup9_Tower_Shell",
                "MatChangeGroup10_MatChangeGroup19_Tower_Inside.001"
            ];
            const towerSpecialMatNames = [
                "Tower",
                "Tower_inside"
            ];
            // Car special
            model.traverse(function(child) {
                if (child.isMesh) {
                    let materials = Array.isArray(child.material) ? child.material : [child.material];
                    materials.forEach(mat => {
                        if (mat && (envMatNames.includes(mat.name) || turbainEnvMatNames.includes(mat.name))) {
                            envTransparentMats.push(mat);
                            envOriginals.push({mat: mat, opacity: mat.opacity, transparent: mat.transparent});
                        }
                    });
                    if (envMeshNames.includes(child.name)) {
                        let materials2 = Array.isArray(child.material) ? child.material : [child.material];
                        materials2.forEach(mat => {
                            if (mat) {
                                envTransparentMats.push(mat);
                                envOriginals.push({mat: mat, opacity: mat.opacity, transparent: mat.transparent});
                            }
                        });
                    }
                    // Tower special
                    if (towerSpecialMeshes.includes(child.name)) {
                        let towerMats = Array.isArray(child.material) ? child.material : [child.material];
                        towerMats.forEach(mat => {
                            if (mat && towerSpecialMatNames.includes(mat.name)) {
                                towerSpecialMats.push(mat);
                                towerSpecialOriginals.push({mat: mat, opacity: mat.opacity, transparent: mat.transparent});
                            }
                        });
                    }
                    // Car special
                    let carMats = Array.isArray(child.material) ? child.material : [child.material];
                    carMats.forEach(mat => {
                        if (mat && carSpecialMatNames.includes(mat.name)) {
                            if (!carSpecialMats.includes(mat)) {
                                carSpecialMats.push(mat);
                                carSpecialOriginals.push({mat: mat, opacity: mat.opacity, transparent: mat.transparent});
                            }
                        }
                    });
                    // Tower main material ref for double side
                    if (child.name && child.name.toLowerCase().includes("tower")) {
                        let towerMats = Array.isArray(child.material) ? child.material : [child.material];
                        towerMats.forEach(mat => {
                            if (mat && !towerMaterialRef) {
                                towerMaterialRef = mat;
                                towerMaterialRef.side = THREE.DoubleSide;
                                towerMaterialRef.needsUpdate = true;
                            }
                        });
                    }
                }
            });

            loadingOverlay.style.display = 'none';
            popup.style.display = 'none';
        });

        // --- Load blades GLB
        bladesPivot = new THREE.Object3D();
        bladesPivot.position.set(0, 187, 0);
        scene.add(bladesPivot);
        loader.load('Blades.glb', function (gltf) {
            bladesModel = gltf.scene;
            bladesModel.scale.set(2, 2, 2);
            bladesModel.visible = true;
            bladesPivot.add(bladesModel);
            bladesTransparentMats = [];
            bladesOriginals = [];
            bladesModel.traverse(function(child) {
                if (child.isMesh) {
                    let materials = Array.isArray(child.material) ? child.material : [child.material];
                    materials.forEach(mat => {
                        if (mat && turbainBladesMatNames.includes(mat.name)) {
                            bladesTransparentMats.push(mat);
                            bladesOriginals.push({mat: mat, opacity: mat.opacity, transparent: mat.transparent});
                        }
                    });
                }
            });
        });

        showHotspots("main");
        window.addEventListener('resize', onWindowResize, false);
    }

    function onWindowResize() {
        for (let k in cameras) {
            cameras[k].aspect = window.innerWidth / window.innerHeight;
            cameras[k].updateProjectionMatrix();
        }
        renderer.setSize(window.innerWidth, window.innerHeight);
        updateDomHotspotMarkerPositions();
    }

    function removeAllHotspotDomMarkers() {
        allHotspotDomMarkers.forEach(m => m.remove());
        allHotspotDomMarkers = [];
    }

    function getHotspotMarkerSize() {
        // Main view: 20x20, Others: 32x32
        return activeView === "main" ? 20 : 32;
    }

    function showDomHotspotMarkers(view) {
        removeAllHotspotDomMarkers();
        hotspotData[view].forEach((hotspot, idx) => {
            const marker = document.createElement("button");
            marker.className = "hotspot-dom-marker";
            marker.setAttribute("tabindex", 0);
            marker.setAttribute("aria-label", hotspot.name);

            // Dynamically set marker size for main view vs others
            const size = view === "main" ? 20 : 32;
            marker.style.width = size + "px";
            marker.style.height = size + "px";

            marker.innerHTML = `
                <svg width="${Math.round(size*0.56)}" height="${Math.round(size*0.56)}" viewBox="0 0 24 24" fill="none">
                  <rect x="11" y="5" width="2" height="14" rx="1" fill="#fff"/>
                  <rect x="5" y="11" width="14" height="2" rx="1" fill="#fff"/>
                </svg>
                <span class="hotspot-tooltip">${hotspot.name}</span>
            `;
            marker.addEventListener("mouseenter", () => marker.classList.add("active"));
            marker.addEventListener("mouseleave", () => marker.classList.remove("active"));
            marker.addEventListener("focus", () => marker.classList.add("active"));
            marker.addEventListener("blur", () => marker.classList.remove("active"));
            marker.addEventListener("click", (event) => {
                if (activeView === "main" && hotspot.view) {
                    switchView(hotspot.view);
                } else {
                    popupTitle.innerText = hotspot.title;
                    popupDesc.innerText = hotspot.desc;
                    const rect = marker.getBoundingClientRect();
                    let x = rect.left + 48;
                    let y = rect.top - 10;
                    popup.style.display = 'block';
                    popup.style.left = x + "px";
                    popup.style.top = y + "px";
                    setTimeout(() => {
                        const popupRect = popup.getBoundingClientRect();
                        const margin = 10;
                        if (popupRect.right > window.innerWidth - margin) {
                            popup.style.left = (window.innerWidth - popupRect.width - margin) + "px";
                        }
                        if (popupRect.bottom > window.innerHeight - margin) {
                            popup.style.top = (window.innerHeight - popupRect.height - margin) + "px";
                        }
                        if (popupRect.left < margin) {
                            popup.style.left = margin + "px";
                        }
                        if (popupRect.top < margin) {
                            popup.style.top = margin + "px";
                        }
                    }, 10);
                    exploreBtn.onclick = () => window.open('#', '_blank');
                }
            });
            document.body.appendChild(marker);
            allHotspotDomMarkers.push(marker);
        });
        updateDomHotspotMarkerPositions();
    }
    function updateDomHotspotMarkerPositions() {
        const size = getHotspotMarkerSize();
        allHotspotDomMarkers.forEach((marker, idx) => {
            marker.style.width = size + "px";
            marker.style.height = size + "px";
            const svg = marker.querySelector("svg");
            if (svg) {
                svg.setAttribute("width", Math.round(size*0.56));
                svg.setAttribute("height", Math.round(size*0.56));
            }
            const hotspot = hotspotData[activeView][idx];
            if (!hotspot) return;
            const pos = getHotspotVector(hotspot).clone().project(camera);
            const x = (pos.x * 0.5 + 0.5) * window.innerWidth;
            const y = (-pos.y * 0.5 + 0.5) * window.innerHeight;
            marker.style.left = (x - size/2) + "px";
            marker.style.top = (y - size/2) + "px";
        });
    }

    function showHotspots(view) {
        showDomHotspotMarkers(view);
    }

    // --- CAMERA SWITCH LOGIC ---
    function switchView(view) {
        popup.style.display = 'none';
        fadeTransition(() => {
            activeView = view;
            camera = cameras[view];
            Object.entries(controls).forEach(([k, ctrl]) => ctrl.enabled = (k === view));
            if(view==="main") controls.main.target.copy(getHotspotVector(hotspotData.main[0]));
            if(view==="turbain") controls.turbain.target.copy(getHotspotVector(hotspotData.turbain[0]));
            if(view==="tower") controls.tower.target.copy(getHotspotVector(hotspotData.tower[0]));
            if(view==="car") controls.car.target.copy(getHotspotVector(hotspotData.car[0]));
            showHotspots(view);
            backBtn.style.display = (view === "main") ? "none" : "block";

            // === Only set opacity for that view's materials ===
            if (view === "turbain") {
                setAllMaterialsOpacityToLow();
                restoreTowerSpecialOpacity();
                restoreCarSpecialOpacity();
                setBladesVisibility(true);
            }
            else if (view === "main") {
                restoreEnvMaterials();
                restoreBladesMaterials();
                restoreTowerSpecialOpacity();
                restoreCarSpecialOpacity();
                setBladesVisibility(true);
            }
            else if (view === "tower") {
                restoreEnvMaterials();
                restoreBladesMaterials();
                setTowerSpecialOpacity(0.2);
                restoreCarSpecialOpacity();
                setBladesVisibility(true);
            }
            else if (view === "car") {
                restoreEnvMaterials();
                restoreBladesMaterials();
                restoreTowerSpecialOpacity();
                setCarSpecialOpacity(0.2);
                setBladesVisibility(true);
            }
            else {
                restoreEnvMaterials();
                restoreBladesMaterials();
                restoreTowerSpecialOpacity();
                restoreCarSpecialOpacity();
                setBladesVisibility(true);
            }
        });
    }

    // --- UI/Animation/Hotspot Events ---
    function fadeTransition(cb) {
        fadeOverlay.style.pointerEvents = 'auto';
        fadeOverlay.style.opacity = 1;
        setTimeout(() => {
            cb();
            setTimeout(() => {
                fadeOverlay.style.opacity = 0;
                setTimeout(() => { fadeOverlay.style.pointerEvents = 'none'; }, 500);
            }, 100);
        }, 500);
    }
    popupCloseBtn.onclick = () => { popup.style.display = 'none'; };
    backBtn.onclick = () => { switchView("main"); };

    function animateFn() {
        requestAnimationFrame(animateFn);
        if (controls[activeView] && controls[activeView].update) controls[activeView].update();
        // Wind turbines: realistic speed about 5-20 rpm. Let's use 12 seconds for one rotation (rpm=5).
        // One frame: delta = 2*PI/ (60fps*12sec) ~ 0.0087 rad per frame
        if (bladesPivot) bladesPivot.rotation.z -= 0.0087; // clockwise, slower
        renderer.render(scene, camera);
        updateDomHotspotMarkerPositions();
    }

    // --- BOOT ---
    window.onload = function () {
        popup.style.display = 'none';
        init();
        animateFn();
    };

    window.addEventListener('resize', updateDomHotspotMarkerPositions);
    </script>
</body>
</html>
