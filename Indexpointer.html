<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vestas Turbine Interactive</title>
    <!-- Load Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <div id="fade-overlay" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:#111;opacity:0;pointer-events:none;z-index:9999;transition:opacity 0.5s;"></div>
    <!-- Load TailwindCSS for easy styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Basic page styling */
        body {
            margin: 0; 
            overflow: hidden; 
            font-family: 'Inter', sans-serif; 
            background-color: #1a202c; 
            color: #e2e8f0;
        }
        /* Container for 3D view */
        #webgl-output {
            display: block; 
            width: 100vw; 
            height: 100vh; 
            position: absolute; 
            top: 0; 
            left: 0; 
            z-index: 1;
        }
        /* Overlay shown while loading models */
        #loading-overlay {
            position: absolute; 
            top: 0; left: 0; 
            width: 100%; height: 100%;
            background-color: rgba(7, 10, 200, 0.7); 
            display: flex; 
            justify-content: center; 
            align-items: center;
            color: white; 
            font-size: 1.5rem; 
            z-index: 1000; 
            flex-direction: column; 
            gap: 1rem;
        }
        /* Spinner animation for loading */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #3498db; 
            border-radius: 50%;
            width: 40px; 
            height: 40px; 
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        /* Styling for the floating hotspot labels */
        .hotspot-label {
            position: absolute;
            background: #014282;
            color: #fff;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.95rem;
            pointer-events: none;
            white-space: nowrap;
            z-index: 20;
            display: none;
            transition: opacity 0.2s;
        }
        /* Styling for the popup info window */
        .hotspot-popup {
            position: absolute;
            background: #fff;
            color: #222;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            padding: 1.5rem 1.5rem 1rem 1.5rem;
            min-width: 260px;
            z-index: 1001;
            display: none;
            top: 30%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .hotspot-popup h3 { margin-top: 0; }
        .hotspot-popup .close-btn {
            position: absolute; 
            top: 8px; 
            right: 12px; 
            background: none; 
            border: none; 
            font-size: 1.2rem; 
            cursor: pointer;
        }
    </style>
</head>
<!-- [Keep your <head> and CSS as-is] -->
<body>
    <div id="loading-overlay">
        <div class="spinner"></div>
        <p>Vestas Learning...</p>
    </div>
    <div id="webgl-output"></div>
    <!-- Popup that appears when clicking a hotspot -->
    <div id="hotspot-popup" class="hotspot-popup">
        <button class="close-btn" onclick="document.getElementById('hotspot-popup').style.display='none'">&times;</button>
        <h3 id="popup-title"></h3>
        <p id="popup-desc"></p>
        <button id="explore-btn" class="bg-blue-600 text-white px-3 py-1 rounded mt-2">Explore</button>
    </div>
    <!-- Back Button -->
    <button id="back-btn" style="display:none; position:fixed; top:32px; left:32px; width:48px; height:48px; border-radius:50%; background:#014282; color:#fff; font-size:2em; border:none; z-index:9;">&#8592;</button>
    <!-- Three.js and related libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/PointerLockControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script>
    // Fade overlay logic
    const fadeOverlay = document.getElementById('fade-overlay');
    function fadeTransition(cb) {
        fadeOverlay.style.pointerEvents = 'auto';
        fadeOverlay.style.opacity = 1;
        setTimeout(() => {
            cb();
            setTimeout(() => {
                fadeOverlay.style.opacity = 0;
                setTimeout(() => {
                    fadeOverlay.style.pointerEvents = 'none';
                }, 500);
            }, 100);
        }, 500);
    }

    // --- Camera, Controls, Scene, Renderer ---
    let scene, camera, renderer;
    let controls = {};
    let activeView = "main";
    let allHotspotMeshes = [];
    let allHotspotLabels = [];
    let bladesModel = null, bladesPivot = null;
    const loadingOverlay = document.getElementById('loading-overlay');
    const container = document.getElementById('webgl-output');

    // --- Camera Setup ---
    const cameras = {};
    cameras.main = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 2000);
    cameras.main.position.set(300, 90, 240);
    cameras.turbain = new THREE.PerspectiveCamera(80, window.innerWidth / window.innerHeight, 0.1, 2000);
    cameras.turbain.position.set(0, 300, 10);
    cameras.tower = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 2000);
    cameras.tower.position.set(0, 8, -5);
    cameras.car = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 2000);
    cameras.car.position.set(-80, -80, -80);

    controls.main = new THREE.OrbitControls(cameras.main, container);
    controls.turbain = new THREE.OrbitControls(cameras.turbain, container);
    controls.car = new THREE.OrbitControls(cameras.car, container);
    controls.tower = new THREE.PointerLockControls(cameras.tower, container);

    // --- Hotspots Data ---
    const hotspotData = {
        main: [
            { name: "Turbine", position: {x: 0, y: 187, z: -10}, title: "Turbine", desc: "Go in-depth inside the Turbine.", view: "turbain" },
            { name: "Tower", position: {x: 0, y: 10, z: 0}, title: "Tower", desc: "Go in-depth inside the Tower.", view: "tower" },
            { name: "Car", position: {x: 25, y: 3, z: 1}, title: "Car", desc: "Go to Service Van.", view: "car" }
        ],
        turbain: [
            { name: "Drivetrain", position: {x: 5, y: 190, z: -13}, title: "Drivetrain", desc: "Drivetrain details" },
            { name: "Yaw", position: {x: 2, y: 186, z: -21}, title: "Yaw", desc: "Yaw system details" },
            { name: "Hydraulics", position: {x: 8, y: 183, z: -18}, title: "Hydraulics", desc: "Hydraulics details" },
            { name: "Power Generator", position: {x: 0, y: 193, z: -14}, title: "Power Generator", desc: "Power Generator details" },
            { name: "Controls & Safety", position: {x: -7, y: 188, z: -18}, title: "Controls & Safety", desc: "Controls & Safety details" },
            { name: "Turbine System", position: {x: -4, y: 181, z: -12}, title: "Turbine System", desc: "Turbine System details" },
            { name: "Power Supply", position: {x: 1, y: 185, z: -5}, title: "Power Supply", desc: "Power Supply details" }
        ],
        tower: [
            { name: "Safety", position: {x: 1, y: 44, z: 2}, title: "Safety", desc: "Safety details" },
            { name: "Turbine Operation", position: {x: -2, y: 46, z: -4}, title: "Turbine Operation", desc: "Turbine Operation details" }
        ],
        car: [
            { name: "Scheduled Service", position: {x: 33, y: 6, z: 7}, title: "Scheduled Service", desc: "Scheduled Service info" },
            { name: "Documentation", position: {x: 31, y: 7, z: 10}, title: "Documentation", desc: "Documentation info" },
            { name: "Trouble Shooting Tools", position: {x: 30, y: 6, z: 4}, title: "Trouble Shooting Tools", desc: "Trouble Shooting Tools info" }
        ]
    };

    function init() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a202c);

        camera = cameras.main;
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        container.appendChild(renderer.domElement);

        // Lighting
        scene.add(new THREE.AmbientLight(0xffffff, 0.5));
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(5, 10, 7);
        scene.add(dirLight);

        // Models
        const loader = new THREE.GLTFLoader();
        loader.load(
            'windmillenv.glb',
            function (gltf) {
                const model = gltf.scene;
                model.scale.set(2, 2, 2);
                scene.add(model);
                loadingOverlay.style.display = 'none';
            }
        );

        bladesPivot = new THREE.Object3D();
        bladesPivot.position.set(0, 187, 0);
        scene.add(bladesPivot);

        loader.load(
            'Blades.glb',
            function (gltf) {
                bladesModel = gltf.scene;
                bladesModel.scale.set(2, 2, 2);
                bladesPivot.add(bladesModel);
            }
        );

        Object.values(controls).forEach(c => {
            if (c instanceof THREE.OrbitControls) {
                c.enableDamping = true;
                c.dampingFactor = 0.05;
                c.enablePan = false;
                c.enableZoom = false;
                c.minPolarAngle = 0;
                c.maxPolarAngle = Math.PI / 2;
                c.target.set(0, 50, 0);
                c.update();
            }
        });

        container.addEventListener('click', function() {
            if (activeView === "tower" && !controls.tower.isLocked) controls.tower.lock();
        });

        showHotspots("main");
        window.addEventListener('resize', onWindowResize, false);
    }

    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function createHotspotMesh(hotspot, idx) {
        const map = new THREE.TextureLoader().load(
            `data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><circle cx='32' cy='32' r='28' fill='${encodeURIComponent("#014282")}' fill-opacity='0.8'/></svg>`
        );
        const mat = new THREE.SpriteMaterial({ map: map, transparent: true, opacity: 0.5, depthTest: false });
        const sprite = new THREE.Sprite(mat);
        sprite.position.set(hotspot.position.x, hotspot.position.y, hotspot.position.z);
        sprite.scale.set(13, 13, 1);
        sprite.renderOrder = 999;
        sprite.userData.hotspotIndex = idx;
        return sprite;
    }

    function showHotspots(view) {
        allHotspotMeshes.forEach(mesh => scene.remove(mesh));
        allHotspotLabels.forEach(label => { if (label && label.remove) label.remove(); });
        allHotspotMeshes = [];
        allHotspotLabels = [];
        hotspotData[view].forEach((hotspot, idx) => {
            const mesh = createHotspotMesh(hotspot, idx);
            scene.add(mesh);
            allHotspotMeshes.push(mesh);

            const label = document.createElement('div');
            label.className = 'hotspot-label';
            label.innerText = hotspot.name;
            document.body.appendChild(label);
            allHotspotLabels.push(label);
        });
    }

    function switchView(view) {
        fadeTransition(() => {
            activeView = view;
            camera = cameras[view];
            Object.entries(controls).forEach(([k, ctrl]) => ctrl.enabled = (k === view));
            if (view === "tower") controls.tower.lock();
            showHotspots(view);
            document.getElementById("back-btn").style.display = (view === "main") ? "none" : "block";
        });
    }

    // --- Hotspot Interactivity ---
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();
    let INTERSECTED = null;
    const popup = document.getElementById('hotspot-popup');
    const popupTitle = document.getElementById('popup-title');
    const popupDesc = document.getElementById('popup-desc');
    const exploreBtn = document.getElementById('explore-btn');

    function setupHotspotEvents() {
        renderer.domElement.addEventListener('mousemove', (event) => {
            const rect = renderer.domElement.getBoundingClientRect();
            mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(allHotspotMeshes);
            allHotspotLabels.forEach(label => label.style.display = 'none');
            INTERSECTED = null;
            if (intersects.length > 0) {
                const idx = intersects[0].object.userData.hotspotIndex;
                INTERSECTED = idx;
                allHotspotLabels[idx].style.display = 'block';
                const vector = allHotspotMeshes[idx].position.clone().project(camera);
                const x = (vector.x * 0.5 + 0.5) * window.innerWidth;
                const y = (-vector.y * 0.5 + 0.5) * window.innerHeight;
                allHotspotLabels[idx].style.left = `${x}px`;
                allHotspotLabels[idx].style.top = `${y - 30}px`;
            }
        });
        renderer.domElement.addEventListener('mouseleave', () => {
            allHotspotLabels.forEach(label => label.style.display = 'none');
            INTERSECTED = null;
        });
        renderer.domElement.addEventListener('click', (event) => {
            if (INTERSECTED !== null) {
                const hotspot = hotspotData[activeView][INTERSECTED];
                if (activeView === "main" && hotspot.view) {
                    switchView(hotspot.view);
                } else {
                    popupTitle.innerText = hotspot.title;
                    popupDesc.innerText = hotspot.desc;
                    popup.style.display = 'block';
                    exploreBtn.onclick = () => window.open('#', '_blank');
                }
            }
        });
    }
    document.querySelector('.close-btn').onclick = () => {
        popup.style.display = 'none';
    };
    document.getElementById('back-btn').onclick = () => {
        switchView("main");
    };

    function updateHotspotLabels() {
        allHotspotMeshes.forEach((mesh, idx) => {
            if (allHotspotLabels[idx].style.display === 'block') {
                const vector = mesh.position.clone().project(camera);
                const x = (vector.x * 0.5 + 0.5) * window.innerWidth;
                const y = (-vector.y * 0.5 + 0.5) * window.innerHeight;
                allHotspotLabels[idx].style.left = `${x}px`;
                allHotspotLabels[idx].style.top = `${y - 30}px`;
            }
        });
    }

    function animateFn() {
        requestAnimationFrame(animateFn);
        if (controls[activeView] && controls[activeView].update) controls[activeView].update();
        if (bladesPivot) bladesPivot.rotation.z += 0.02;
        renderer.render(scene, camera);
        updateHotspotLabels();
    }

    window.onload = function () {
        init();
        setupHotspotEvents();
        animateFn();
    };
</script>
</body>
</html>
