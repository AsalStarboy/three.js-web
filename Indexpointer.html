<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vestas Turbine Interactive</title>
    <!-- Load Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <!-- Load TailwindCSS for easy styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Basic page styling */
        body {
            margin: 0; 
            overflow: hidden; 
            font-family: 'Inter', sans-serif; 
            background-color: #1a202c; 
            color: #e2e8f0;
        }
        /* Container for 3D view */
        #webgl-output {
            display: block; 
            width: 100vw; 
            height: 100vh; 
            position: absolute; 
            top: 0; 
            left: 0; 
            z-index: 1;
        }
        /* Overlay shown while loading models */
        #loading-overlay {
            position: absolute; 
            top: 0; left: 0; 
            width: 100%; height: 100%;
            background-color: rgba(7, 10, 200, 0.7); 
            display: flex; 
            justify-content: center; 
            align-items: center;
            color: white; 
            font-size: 1.5rem; 
            z-index: 1000; 
            flex-direction: column; 
            gap: 1rem;
        }
        /* Spinner animation for loading */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #3498db; 
            border-radius: 50%;
            width: 40px; 
            height: 40px; 
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        /* Styling for the floating hotspot labels */
        .hotspot-label {
            position: absolute;
            background: #014282;
            color: #fff;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.95rem;
            pointer-events: none;
            white-space: nowrap;
            z-index: 20;
            display: none;
            transition: opacity 0.2s;
        }
        /* Styling for the popup info window */
        .hotspot-popup {
            position: absolute;
            background: #fff;
            color: #222;
            border-radius: 8px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            padding: 1.5rem 1.5rem 1rem 1.5rem;
            min-width: 260px;
            z-index: 1001;
            display: none;
            top: 30%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .hotspot-popup h3 { margin-top: 0; }
        .hotspot-popup .close-btn {
            position: absolute; 
            top: 8px; 
            right: 12px; 
            background: none; 
            border: none; 
            font-size: 1.2rem; 
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Overlay shown while models are loading -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <p>Vestas Learning...</p>
    </div>
    <!-- 3D rendering container -->
    <div id="webgl-output"></div>
    <!-- Popup that appears when clicking a hotspot -->
    <div id="hotspot-popup" class="hotspot-popup">
        <button class="close-btn" onclick="document.getElementById('hotspot-popup').style.display='none'">&times;</button>
        <h3 id="popup-title"></h3>
        <p id="popup-desc"></p>
    </div>
    <!-- Three.js and related libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script>
        // === Hotspot Style Controls ===
        const HOTSPOT_COLOR = "#014282";      // Marker color (hex code)
        const HOTSPOT_OPACITY = 0.5;          // 0.5 = 50% transparent
        const HOTSPOT_SIZE = 13;              // Marker size

        let scene, camera, renderer, controls;
        let ambientLight, directionalLight;
        let bladesModel = null;    // Will hold the blade model after loading
        let bladesPivot = null;    // Used for rotating blades
        const loadingOverlay = document.getElementById('loading-overlay');
        const container = document.getElementById('webgl-output');
        const currentCameraId = 1; // For future camera switching, if needed

        // ==================== HOTSPOT POSITIONS ====================
        // To add or move a hotspot (the clickable marker in 3D):
        // 1. Each object below represents a hotspot.
        // 2. The `position` field determines where the hotspot appears.
        //    - x: left/right   (increase right, decrease left)
        //    - y: up/down      (increase up, decrease down)
        //    - z: forward/back (increase toward you, decrease away)
        // 3. Change the numbers to move the hotspot.
        // 4. Save and reload the page to see the effect.
        //
        // Example: position: { x: 0, y: 260, z: 0 }
        //
        // Tip: Adjust one value at a time and reload to see the new hotspot location.
        const hotspots = [
            {
                name: "Turbine", // The label for the hotspot
                position: { x: 0, y: 187, z: -10 }, // <--- Change these values to move the hotspot
                cameraIds: [1],
                title: "Turbine",
                desc: "This is the top of the wind turbine.",
            },
            {
                name: "Tower",
                position: { x: 0, y: 10, z: 0 }, // <--- Change these values to move the hotspot
                cameraIds: [1],
                title: "Tower",
                desc: "This is the tower of the wind turbine.",
            },
            {
                name: "Car",
                position: { x: 25, y: 3, z: 1}, // <--- Change these values to move the hotspot
                cameraIds: [1],
                title: "Car",
                desc: "This is the placeholder for the car model.",
            }
        ];
        // ==================== HOTSPOT POSITIONS END ====================

        const hotspotMeshes = []; // Store 3D marker sprites
        const hotspotLabels = []; // Store HTML labels for each hotspot

        // === 3D SCENE INITIALIZATION ===
        function init() {
            // Create a new Three.js scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a202c);

            // Create and position the camera
            camera = new THREE.PerspectiveCamera(
                70, // Field of view
                window.innerWidth / window.innerHeight, // Aspect ratio
                0.1, // Near plane
                2000 // Far plane
            );
            camera.position.set(300, 90, 240); // <--- Camera starting position
            camera.lookAt(0, 130, 0); // Camera looks at this point

            // Create WebGL renderer and add to page
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);

            // Add camera controls (mouse drag/zoom)
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minPolarAngle = 0;
            controls.maxPolarAngle = Math.PI / 2;
            // Lock zoom distance (optional: change/remove for free zoom)
            const lockedDistance = camera.position.distanceTo(new THREE.Vector3(0, 500, 0));
            controls.minDistance = lockedDistance;
            controls.maxDistance = lockedDistance;
            controls.enableZoom = false; // Disable zoom (optional)
            controls.enablePan = false;  // Disable pan (optional)
            controls.target.set(0, 50, 0); // Camera focus point
            controls.update();

            // Add ambient (general) light to the scene
            ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);

            // Add directional light (like sunlight)
            directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 10, 7);
            directionalLight.castShadow = true;
            scene.add(directionalLight);

            // GLTFLoader loads .glb/.gltf 3D models
            const loader = new THREE.GLTFLoader();

            // === Load windmill model ===
            loader.load(
                'windmillenv.glb', // Path to windmill model file
                function (gltf) {
                    const model = gltf.scene;
                    model.scale.set(2, 2, 2); // Make model bigger
                    scene.add(model);
                    loadingOverlay.style.display = 'none'; // Hide loading overlay
                },
                undefined,
                function (error) {
                    console.error('An error occurred while loading the model:', error);
                    loadingOverlay.innerHTML = '<p class="text-red-500">Failed to load 3D model.</p>';
                }
            );

            // === Add a pivot point for the blades, so they can rotate ===
            bladesPivot = new THREE.Object3D();
            bladesPivot.position.set(0, 187, 0); // Place pivot where blades connect
            scene.add(bladesPivot);

            // === Load blade model and attach to pivot ===
            loader.load(
                'Blades.glb', // Path to blade model file
                function (gltf) {
                    bladesModel = gltf.scene;
                    bladesModel.scale.set(2, 2, 2); // Make blades bigger
                    bladesModel.position.set(0, 0, 0);
                    bladesModel.rotation.set(0, 0, 0);
                    bladesPivot.add(bladesModel); // Attach blades to pivot for animation
                },
                undefined,
                function (error) {
                    console.error('An error occurred while loading Blades.glb:', error);
                }
            );

            // === Add Hotspots to Scene ===
            hotspots.forEach((hotspot, idx) => {
                // Only add hotspots that should show in this camera mode
                if (!hotspot.cameraIds.includes(currentCameraId)) return;

                // --- Create a visible marker in 3D using a circle sprite ---
                const map = new THREE.TextureLoader().load(
                    `data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><circle cx='32' cy='32' r='28' fill='${encodeURIComponent(HOTSPOT_COLOR)}' fill-opacity='0.8'/></svg>`
                );
                const material = new THREE.SpriteMaterial({ map: map, transparent: true, opacity: HOTSPOT_OPACITY, depthTest: false });
                const sprite = new THREE.Sprite(material);
                sprite.position.set(hotspot.position.x, hotspot.position.y, hotspot.position.z);
                sprite.scale.set(HOTSPOT_SIZE, HOTSPOT_SIZE, 1); // Size of marker
                sprite.renderOrder = 999; // Always draw on top
                sprite.userData.hotspotIndex = idx; // Store index for events
                scene.add(sprite);
                hotspotMeshes.push(sprite);

                // --- Create HTML label for the hotspot (shown on hover) ---
                const label = document.createElement('div');
                label.className = 'hotspot-label';
                label.innerText = hotspot.name;
                document.body.appendChild(label);
                hotspotLabels.push(label);
            });

            // Handle browser resizing
            window.addEventListener('resize', onWindowResize, false);
        }

        // === Update camera and renderer size when window is resized ===
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // === Hotspot Interactivity ===
        // Raycaster lets us detect what the mouse is over in 3D
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        let INTERSECTED = null; // Which hotspot is hovered

        // Get references to popup elements for later
        const popup = document.getElementById('hotspot-popup');
        const popupTitle = document.getElementById('popup-title');
        const popupDesc = document.getElementById('popup-desc');

        // Set up mouse events for hotspots (hover and click)
        function setupHotspotEvents() {
            // --- Mouse move: show label if hovering a hotspot ---
            renderer.domElement.addEventListener('mousemove', (event) => {
                const rect = renderer.domElement.getBoundingClientRect();
                mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
                mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObjects(hotspotMeshes);

                // Hide all labels first
                hotspotLabels.forEach(label => label.style.display = 'none');
                INTERSECTED = null;

                // If the mouse is over a hotspot, show its label
                if (intersects.length > 0) {
                    const idx = intersects[0].object.userData.hotspotIndex;
                    INTERSECTED = idx;
                    hotspotLabels[idx].style.display = 'block';
                    // Position the label above the marker
                    const vector = hotspotMeshes[idx].position.clone().project(camera);
                    const x = (vector.x * 0.5 + 0.5) * window.innerWidth;
                    const y = (-vector.y * 0.5 + 0.5) * window.innerHeight;
                    hotspotLabels[idx].style.left = `${x}px`;
                    hotspotLabels[idx].style.top = `${y - 30}px`;
                }
            });

            // --- Mouse leaves the canvas: hide all labels ---
            renderer.domElement.addEventListener('mouseleave', () => {
                hotspotLabels.forEach(label => label.style.display = 'none');
                INTERSECTED = null;
            });

            // --- Mouse click: show popup if clicking a hotspot ---
            renderer.domElement.addEventListener('click', (event) => {
                if (INTERSECTED !== null) {
                    const hotspot = hotspots[INTERSECTED];
                    // Show the popup with hotspot info
                    popupTitle.innerText = hotspot.title;
                    popupDesc.innerText = hotspot.desc;
                    popup.style.display = 'block';
                }
            });
        }

        // --- Popup close button handler ---
        document.querySelector('.close-btn').onclick = () => {
            popup.style.display = 'none';
        };

        // --- Keep labels in right position as camera moves ---
        function updateHotspotLabels() {
            hotspotMeshes.forEach((mesh, idx) => {
                if (hotspotLabels[idx].style.display === 'block') {
                    const vector = mesh.position.clone().project(camera);
                    const x = (vector.x * 0.5 + 0.5) * window.innerWidth;
                    const y = (-vector.y * 0.5 + 0.5) * window.innerHeight;
                    hotspotLabels[idx].style.left = `${x}px`;
                    hotspotLabels[idx].style.top = `${y - 30}px`;
                }
            });
        }

        // === Animation/render loop ===
        function animateFn() {
            requestAnimationFrame(animateFn);
            controls.update(); // Smooth camera movement

            // --- Animate the turbine blades (rotate them) ---
            if (bladesPivot) {
                bladesPivot.rotation.z += 0.02;
            }

            // --- Keep hotspot markers visible ---
            hotspotMeshes.forEach((sprite, idx) => {
                sprite.material.opacity = HOTSPOT_OPACITY;
            });

            renderer.render(scene, camera); // Draw the scene
            updateHotspotLabels(); // Update label positions
        }

        // === Start everything when the page loads ===
        window.onload = function () {
            init();               // Set up scene and objects
            setupHotspotEvents(); // Add interactivity
            animateFn();          // Start animation loop
        };
    </script>
</body>
</html>
